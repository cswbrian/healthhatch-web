<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
</head>
<body>
  <script>
    console.log('=== Decap CMS Debug Logging ===');
    
    // Log all messages received
    window.addEventListener('message', function(event) {
      console.log('[MESSAGE] Received:', event.data);
      console.log('[MESSAGE] From origin:', event.origin);
      console.log('[MESSAGE] Current origin:', window.location.origin);
      
      // Check if it's an authorization message
      if (typeof event.data === 'string' && event.data.startsWith('authorization:')) {
        console.log('[AUTH] Authorization message detected!');
        console.log('[AUTH] Full message:', event.data);
        
        // Parse the message
        const parts = event.data.split(':');
        if (parts.length >= 4) {
          const provider = parts[1];
          const status = parts[2];
          const dataStr = parts.slice(3).join(':');
          console.log('[AUTH] Provider:', provider);
          console.log('[AUTH] Status:', status);
          console.log('[AUTH] Data:', dataStr);
          
          try {
            const data = JSON.parse(dataStr);
            console.log('[AUTH] Parsed data:', data);
            console.log('[AUTH] Token present:', !!data.token);
          } catch (e) {
            console.error('[AUTH] Failed to parse data:', e);
          }
        }
      }
    });
    
    // Wait for Decap CMS to fully initialize (with strict limit to prevent infinite loop)
    window.addEventListener('load', function() {
      console.log('[CMS] Window loaded, waiting for Decap CMS...');
      
      let checkCount = 0;
      const MAX_CHECKS = 15; // Strict limit
      let intervalCleared = false;
      
      const checkInterval = setInterval(function() {
        checkCount++;
        
        // Always stop after MAX_CHECKS
        if (checkCount >= MAX_CHECKS) {
          if (!intervalCleared) {
            clearInterval(checkInterval);
            intervalCleared = true;
            console.warn('[CMS] ⚠️ Stopped checking after', MAX_CHECKS, 'attempts');
          }
          return;
        }
        
        // Only log every 3rd check to reduce noise
        if (checkCount % 3 === 0) {
          console.log(`[CMS] Check #${checkCount}...`);
        }
        
        if (window.CMS) {
          if (checkCount === 1 || checkCount % 3 === 0) {
            console.log('[CMS] ✅ Decap CMS found!');
          }
          
          // Try to get backend
          let backend = null;
          if (window.CMS.getBackend) {
            try {
              backend = window.CMS.getBackend();
              if (backend && (checkCount === 1 || checkCount % 3 === 0)) {
                console.log('[CMS] ✅ Backend found!', backend.name);
                console.log('[CMS] Backend methods:', Object.keys(backend));
              }
            } catch (e) {
              if (checkCount === 1 || checkCount % 3 === 0) {
                console.log('[CMS] getBackend() error:', e);
              }
            }
          }
          
          // If backend found, log details and stop
          if (backend) {
            if (!intervalCleared) {
              clearInterval(checkInterval);
              intervalCleared = true;
              console.log('[CMS] ✅ Backend initialized successfully!');
              
              // Check authentication state
              if (typeof backend.currentUser === 'function') {
                try {
                  const user = backend.currentUser();
                  console.log('[CMS] Current user:', user);
                } catch (e) {
                  console.log('[CMS] Error getting current user:', e);
                }
              }
            }
          } else if (checkCount === MAX_CHECKS - 1) {
            // Last check - log final status
            console.warn('[CMS] ⚠️ Backend still undefined after', MAX_CHECKS, 'checks');
            console.log('[CMS] CMS object available:', !!window.CMS);
            console.log('[CMS] getBackend method:', !!window.CMS.getBackend);
          }
        } else if (checkCount === MAX_CHECKS - 1) {
          console.warn('[CMS] ⚠️ Decap CMS not found after', MAX_CHECKS, 'checks');
        }
      }, 1000); // Check every 1 second instead of 500ms
    });
    
    // Log any errors
    window.addEventListener('error', function(event) {
      console.error('[ERROR]', event.error || event.message, event);
    });
    
    // Log unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      console.error('[PROMISE REJECTION]', event.reason);
    });
  </script>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // After Decap CMS script loads, check if it initialized properly
    setTimeout(function() {
      console.log('[CMS] Checking config accessibility...');
      
      // Try to fetch the config to see if it's accessible
      fetch('/admin/config.yml')
        .then(response => {
          console.log('[CMS] Config fetch status:', response.status);
          if (response.ok) {
            return response.text();
          } else {
            console.error('[CMS] Config not accessible, status:', response.status);
          }
        })
        .then(configText => {
          if (configText) {
            console.log('[CMS] Config file is accessible, length:', configText.length);
            console.log('[CMS] Config preview:', configText.substring(0, 200));
          }
        })
        .catch(error => {
          console.error('[CMS] Error fetching config:', error);
        });
      
      // Check if CMS initialized and try to get backend again
      if (window.CMS) {
        console.log('[CMS] Re-checking backend after delay...');
        setTimeout(function() {
          if (window.CMS.getBackend) {
            const backend = window.CMS.getBackend();
            console.log('[CMS] Backend after delay:', backend);
            if (backend) {
              console.log('[CMS] ✅ Backend initialized!');
            } else {
              console.warn('[CMS] ⚠️ Backend still undefined - CMS may not have loaded config');
            }
          }
        }, 2000);
      }
    }, 3000);
  </script>
</body>
</html>
